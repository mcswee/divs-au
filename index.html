<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>divs.au | Australian historical electoral division data</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

</head>
<body>

    <header id="main-header">
        <div class="brand-container">
            <a href="/" class="brand-link">
                <img src="/star.svg" alt="Logo" class="header-logo">
                <div class="text-group">
                    <h1 class="site-title">divs.au</h1>
                    <span class="site-subtitle">Australian historical electoral division data</span>
                </div>
            </a>
        </div>

        <nav class="nav-container">
            <a href="/divisions" class="nav-link">Reports</a>
        </nav>
    </header>

    <main id="app-viewport">
    <section id="map-controls">
        <h1>Federal electoral divisions</h1>
        
        <!--<div class="control-group">
            <label for="year-selector">Election year</label>
            <select id="year-selector">
                <option value="2025" selected>2025 (New)</option>
                <option value="2022">2022</option>
                <option value="2019">2019</option>
            </select>
        </div>-->
      <div id="search-container">
            <input type="text" id="division-search" placeholder="Find a division&hellip;">
        </div>  
    </section>

    <div id="map"></div>
    </main>

<footer id="main-footer">
    <ul class="footer-list">
        <li class="copyright">&copy; 2025 Darren McSweeney</li>
        <li><a href="/diversions">Side Projects</a></li>
        <li><a href="/divulgence">Disclaimer & Privacy</a></li>
    </ul>
</footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // 1. Initialize the map centered on Australia
        // [lat, lng], zoom level
        var map = L.map('map', {
            zoomControl: true,
            minZoom: 4
        }).setView([-27.00, 133.00], 5);

        // 2. Add the Tile Layer (Carto Positron)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 20
        }).addTo(map);

// 3. Load CSV, then GeoJSON
Papa.parse('2025_results.csv', {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
        const stats = {};
        const parties = {}; 

        results.data.forEach(row => {
            if (row.index) {
                const idx = String(row.index).trim();
                stats[idx] = row;
                if (row.party && row.colour) {
                    parties[row.party] = row.colour;
                }
            }
        });

        fetch('2025_electoral_divisions.geojson')
            .then(res => res.json())
            .then(geoData => {
                const geoJsonLayer = L.geoJSON(geoData, {
                    style: (feature) => {
                        const row = stats[String(feature.properties.Index).trim()];
                        return {
                            fillColor: row ? row.colour : '#888',
                            weight: 1,
                            color: 'white',
                            fillOpacity: 0.6 
                        };
                    },
                    onEachFeature: (feature, layer) => {
                        const lookupKey = String(feature.properties.Index).trim();
                        const row = stats[lookupKey];
                        
                        if (row) {
                            // 1. Tooltip (Hover Name)
                            layer.bindTooltip(`<strong>${row.division} (${row.state})</strong>`, {
                                sticky: true, 
                                direction: 'top'
                            });

                            // 2. Click Popup
                            const popupContent = `
                                <div style="border-top: 5px solid ${row.colour}; padding: 5px; min-width: 150px;">
                                    <h3 style="margin: 0 0 5px 0; color: #333;">${row.division} (${row.state})</h3>
                                    <div style="margin-bottom: 5px;">
                                        <strong>Won by: </strong>${row.name} ${row.surname} 
                                        <span style="color: #666;">(${row.party})</span>
                                    </div>
                                    <div style="font-size: 0.9em; border-top: 1px solid #eee; padding-top: 5px;">
                                        ${row.note ? `<em>${row.note}</em>` : ''}
                                    </div>
                                </div>
                            `;
                            layer.bindPopup(popupContent);
                        }

                        // 3. Interaction Effects
                        layer.on({
                            mouseover: (e) => {
                                const l = e.target;
                                l.setStyle({ fillOpacity: 0.9, weight: 2 });
                            },
                            mouseout: (e) => {
                                geoJsonLayer.resetStyle(e.target);
                            }
                        });
                    }
                }).addTo(map);

                // --- LEGEND ---
                const legend = L.control({position: 'bottomright'});
                legend.onAdd = function () {
                    const div = L.DomUtil.create('div', 'info legend');
                    div.innerHTML = '<strong>Parties</strong><br>';
                    // Sort parties alphabetically for a clean legend
                    Object.keys(parties).sort().forEach(p => {
                        div.innerHTML += `<i style="background:${parties[p]}; width: 12px; height: 12px; display: inline-block; margin-right: 5px;"></i> ${p}<br>`;
                    });
                    return div;
                };
                legend.addTo(map);

                // --- SEARCH ---
                document.getElementById('division-search').addEventListener('input', function(e) {
                    const val = e.target.value.toLowerCase().trim();
                    if (!val) return;

                    geoJsonLayer.eachLayer(layer => {
                        const geoIndex = String(layer.feature.properties.Index).trim();
                        const row = stats[geoIndex];
                        if (row && row.division.toLowerCase().includes(val)) {
                            map.fitBounds(layer.getBounds());
                            layer.openPopup();
                        }
                    });
                });
            });
    }
});
    </script>
</body>
</html>
